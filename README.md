# [니땅내땅](https://ddangddang.site/)

<b>야외 활동, 이웃과의 소통을 유도하는 땅따먹기 게임</b>
<br />

## 니땅내땅 소개

### MBTI 그룹 땅따먹기 👨‍💻

<br />
같은 동에서 서로 다른 MBTI 성격을 가진 사람들이 모여 땅따먹기하며 이웃과의 소통을 유도하는 게임입니다.

<br/>

### 프로젝트 기간

-   2022.04.29 ~ 2022.06.03

<br/>

### 😎 팀 멤버

<table>
   <tr>
    <td align="center"><b><a href="https://github.com/pol-dev-shinroo">김재혁</a></b></td>
    <td align="center"><b><a href="https://github.com/piggggggggy">박용태</a></b></td>
     <td align="center"><b><a href="https://github.com/reload1bronze">박재철</a></b></td>
    <td align="center"><b><a href="https://github.com/moto4321">기우석</a></b></td>
    <td align="center"><b><a href="https://github.com/diasm3">박세명</a></b></td>
  </tr>
  <tr>
     <td align="center"><a href="https://github.com/pol-dev-shinroo"><img src="https://avatars.githubusercontent.com/u/102004753?v=4" width="100px" /></a></td>
     <td align="center"><a href="https://github.com/piggggggggy"><img src="https://avatars.githubusercontent.com/u/83635051?v=4" width="100px" /></a></td>
     <td align="center"><a href="https://github.com/reload1bronze"><img src="https://avatars.githubusercontent.com/u/55050662?v=4" width="100px" /></a></td>
     <td align="center"><a href="https://github.com/moto4321"><img src="https://avatars.githubusercontent.com/u/67586085?v=4" width="100px" /></a></td>
    <td align="center"><a href="https://github.com/diasm3"><img src="https://avatars.githubusercontent.com/u/56494905?v=4" width="100px" /></a></td>
    
  </tr>
  <tr>
     <td align="center"><b>Frontend</b></td>
    <td align="center"><b>Frontend</b></td>
    <td align="center"><b>Backend</b></td>
    <td align="center"><b>Backend</b></td>
    <td align="center"><b>Backend</b></td>
  </tr>
</table>

<br/>
<br/>

## 프로젝트 주요 기능

#### 📲 카카오 로그인 / 이메일 로그인

- 카카오를 통한 소셜로그인으로 간단하게 가입할 수 있어요. 이메일 회원가입에서는 중복 가입이 안되도록 중복확인을 눌러야 합니다. 본인의 mbti 를 선택하실 수 있습니다

#### 🕹 3가지 종류의 퀘스트 수행

- 피드 작성하기, 몬스터 처치하기, 타임어택 3가지 종류의 퀘스트가 지도 위에 뿌려져요. 해당 위치 근처에서 퀘스트를 수행할 수 있습니다.

- 몬스터 퀘스트는 몬스터와 직접 게임을 통해서 점수를 올릴 수 있습니다

#### 🏆 달성한 업적 확인

- 퀘스트를 일정 횟수 수행하면 뱃지를 드려요. 마이페이지에서 자신이 달성한 업적을 퀘스트 타입별로 확인할 수 있어요.

#### 🥳 피드와 댓글을 통해 이웃사촌들과 소통하세요

- 특정지역에서 피드를 남겨보세요. 다른 사람이 올린 피드에 댓글로 소통하고 좋아요를 눌러보세요.

#### 📱 채팅페이지

- 좀 더 즉각적인 소통을 위해서 채팅방을 이용하세요. 닉네임이 공개되지 않는 익명채팅입니다.

- 좀 더 즉각적인 소통을 위해서 동네 채팅방을 이용하세요.

#### 🐨 랭킹시스템

-   자신이 쌓은 포인트로 랭킹페이지에서 top 10 랭킹을 확인할 수 있습니다.


<br/>
<br/>

## Architecture
<img src="https://media.discordapp.net/attachments/968689976877400134/982164694825582602/unknown.png" width="1000px" />

<br/>
<br/>

## 🛠 Tools

#### Frontend

<p>
  <p>
   <img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black">
  <img src="https://img.shields.io/badge/html-E34F26?style=for-the-badge&logo=html5&logoColor=white">
  <img src="https://img.shields.io/badge/css-1572B6?style=for-the-badge&logo=css3&logoColor=white">
  <img src="https://img.shields.io/badge/axios-007CE2?style=for-the-badge&logo=axios&logoColor=white" >
  <br>
  <img src="https://img.shields.io/badge/React-61DAFB?style=for-the-badge&logo=React&logoColor=black">
  <img src="https://img.shields.io/badge/React_Router-CA4245?style=for-the-badge&logo=react-router&logoColor=white">
  <img src="https://img.shields.io/badge/redux-%23593d88.svg?style=for-the-badge&logo=redux&logoColor=white" >
        <img src="https://img.shields.io/badge/redux-toolkit-%23593d88.svg?style=for-the-badge&logo=redux&logoColor=white" >
  <br>
  <img src="https://img.shields.io/badge/styled--components-DB7093?style=for-the-badge&logo=styled-components&logoColor=white" >
  <img src="https://img.shields.io/badge/MUI-%230081CB.svg?style=for-the-badge&logo=mui&logoColor=white" >
        <img src="https://img.shields.io/badge/Kakao Map Api-007CE2?style=for-the-badge&logo=KaKao Map Api&logoColor=white">
        <img src="https://img.shields.io/badge/lodash-F7DF1E?style=for-the-badge&logo=lodash&logoColor=white">
  <br>
</p>
</p>

#### Backend

<p>
  <img src="https://img.shields.io/badge/nestjs-E0234E?style=for-the-badge&logo=nestjs&logoColor=white">
  <img src="https://img.shields.io/badge/typescript-2F74C0?style=for-the-badge&logo=typescript&logoColor=white">
  <img src="https://img.shields.io/badge/typeorm-E93625?style=for-the-badge&logo=typeorm&logoColor=white">
  <img src="https://img.shields.io/badge/mariadb-003545?style=for-the-badge&logo=mariadb&logoColor=white">
  <img src="https://img.shields.io/badge/MongoDB-47A248?style=for-the-badge&logo=MongoDB&logoColor=white">
  <img src="https://img.shields.io/badge/jwt-000000?style=for-the-badge&logo=JSONWebTokens&logoColor=white">
  <img src="https://img.shields.io/badge/Socket.io-010101?style=for-the-badge&logo=Socket.io&logoColor=white">
  <img src="https://img.shields.io/badge/Swagger-85EA2D?style=for-the-badge&logo=Swagger&logoColor=black">
  <img src="https://img.shields.io/badge/Jest-C21325?style=for-the-badge&logo=Jest&logoColor=white">
  
</p>

#### Infrastructure

<p>
  <img src="https://img.shields.io/badge/AWS-%23FF9900.svg?style=for-the-badge&logo=amazon-aws&logoColor=white" > 
  <img src="https://img.shields.io/badge/AWS amplify-CA4245?style=for-the-badge&logo=AWS amplify&logoColor=white">
  <img src="https://img.shields.io/badge/docker-F7A81B?style=for-the-badge&logo=docker&logoColor=white">
  <img src="https://img.shields.io/badge/elasticbeanstalk-F7A81B?style=for-the-badge&logo=elastic&logoColor=white">
</p>

#### Dev tools

<p> 
  <img src="https://img.shields.io/badge/Visual%20Studio%20Code-0078d7.svg?style=for-the-badge&logo=visual-studio-code&logoColor=white">
  <img src="https://img.shields.io/badge/git-%23F05033.svg?style=for-the-badge&logo=git&logoColor=white">
  <img src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white">
  <img src="https://img.shields.io/badge/vim-%23121011.svg?style=for-the-badge&logo=vim&logoColor=white">
</p>

#### Design

<p>
  <img src="https://img.shields.io/badge/Figma-F24E1E?style=for-the-badge&logo=Figma&logoColor=white"/>
  <img src="https://img.shields.io/badge/Adobe XD-FF61F6?style=for-the-badge&logo=Adobe XD&logoColor=white"/>
  <img src="https://img.shields.io/badge/Adobe Illustrator-FF9A00?style=for-the-badge&logo=Adobe Illustrator&logoColor=white"/>
  <img src="https://img.shields.io/badge/Adobe Photoshop-31A8FF?style=for-the-badge&logo=Adobe Photoshop&logoColor=white"/>
  <img src="https://img.shields.io/badge/css-1572B6?style=for-the-badge&logo=css3&logoColor=white">
  <img src="https://img.shields.io/badge/mui-1572B6?style=for-the-badge&logo=mui&logoColor=white">
</p>

<br>
<br>

## 🔥 Trouble Shooting


### Issue1

> 외부 API 사용에 따른 지연 시간 발생

#### 원인

- 퀘스트를 생성하기 위해 Kakao API, 공공 주소 API 2가지 API 요청을 보내고 응답을 받게 됩니다.
- 지역당 퀘스트 개수만큼의 API 요청을 각각 보내게 됩니다.
  - ex. 퀘스트 개수가 50개인 경우 Kakao API 요청 50회, 공공 주소 API 요청 50회 필요 
- API 요청을 순서대로 하게 될 경우 API 요청당 1초 정도의 시간이 발생합니다.
  - ex. 10개의 요청을 순차적으로 보낼경우 9초 내외의 시간 소요
     
#### 해결 과정

1. API 요청 병렬화
   - API 요청을 순차적으로 보내지 않고 Promise.all을 활용하여 병렬적으로 보냅니다.
    ```javascript
    // src/quests/quests.service.ts
    const roadAddrs = await Promise.all([
      ..addrIndex.map(({ curPage, idx }) =>
          this.getRoadAddress(curPage, address, idx)
      ),
    ]);
    ```
2. 카카오 429 에러 발생에 따른 요청 횟수 제한
   - 카카오 API는 한번에 다수의 요청을 보낼 경우 429 Too Many Request 에러를 보냅니다.
   - 우선, 제한이 없는 공공 주소 API를 병렬적으로 처리했습니다. 
   - 카카오 API의 경우에는 요청 횟수에 제한을 두었습니다.
   ```javascript
   // src/quests/quests.service.ts
   const limits = 20; // kakaoAPI 429 에러(Too Many Requests) 방지를 위해 요청당 호출수 제한

   for (let begin = 0; begin < pageCount; begin += limits) {
     // 카카오 API 요청 로직
   }
   ```
4. 퀘스트를 사전에 생성 (스케줄링)
   - 위와 같은 방법으로도 50여개의 퀘스트를 생성하는데 여전히 4~5초의 시간이 소요되었습니다.
   - 퀘스트 최초 생성시에는 부득이하게 발생하는 시간이라고 생각했습니다. 
   - 다만, 이후의 요청에서는 API 요청을 사용자가 직접하지 않도록 사전에 퀘스트를 생성하였습니다.
   - 사용자의 활동이 적은 새벽 1시를 기준으로 스케쥴링하였습니다.
   ```javascript
   // src/quests/quests.service.ts
   @Cron('0 0 1 * * *', { timeZone: 'Asia/Seoul' })
   async preCreateQuests() { ... }
   ```


<br/>

### Issue2

채팅을 구현하는 중 접속할 때마다 바뀌는 socket의 id를 어떻게 기존 사용자로 인식할 수 있을지를 고민하였습니다.

#### 원인

socket 통신의 경우 클라이언트 측 socket의 id값이 접속할 때마다 바뀌게 됩니다. 이 때 기존의 사용자를 구분해야 합니다.

#### 해결 과정

1. userId를 고정값으로 하기 위해서 users라는 테이블을 만들어 userId와 socketId를 저장해 놓습니다.
2. socket id가 바뀌어 들어갈 때 users테이블의 userId를 확인하고 socketId를 update하여 기존의 사용자임을 확인합니다.
